#!/usr/bin/python
import subprocess, logging
import sys, os, time
import traceback

ROOT=os.path.dirname(os.path.abspath(__file__))

print ROOT
 
main_log=ROOT+"/log/dockemu.log"
#defaults:
bots=2
ftpservers=1
imagegg="dockemu/ftp:staticip"    #get image for good guys with ftp server and static ip
imagebot="dockemu/botnet"         #get image for botnet guys
server="172.17.5.100"
duration=20
delay=0

try:
    os.remove(main_log)
except OSError:
    pass
logging.basicConfig(filename=main_log,level=logging.DEBUG,  format='%(asctime)s %(message)s', datefmt='%m/%d/%Y %I:%M:%S %p')

#clear screen
os.system(['clear','cls'][os.name =='nt'])

#intro banner
print "##############################################"
print "##############################################"
print "______ _____ _____  _   __ ________  ____   _ "
print "|  _  \  _  /  __ \| | / /|  ___|  \/  | | | |"
print "| | | | | | | /  \/| |/ / | |__ | .  . | | | |"
print "| | | | | | | |    |    \ |  __|| |\/| | | | |"
print "| |/ /\ \_/ / \__/\| |\  \| |___| |  | | |_| |"
print "|___/  \___/ \____/\_| \_/\____/\_|  |_/\___/ "
print ""
print "##############################################"
print "#########  WELCOME TO DOCKEMU V.2.0  #########"
print "###  BRUTE FORCE ATTACK TO MESH NEWTORKS #####"
print "##############################################"
print ""
print ""

try:
	ftpservers = input('How many ftpservers do you need? [defaults=%s]: '%ftpservers)
	print
except KeyboardInterrupt:
	sys.exit(0)
except:
	print " ftpservers not provided, using defaults (%s)"%ftpservers
	print

try:
	bots = input('How many bots do you need? [defaults=%s]: '%bots)
	print
except KeyboardInterrupt:
	sys.exit(0)
except:
	print " bots not provided, using defaults (%s)"%bots
	print

#duration of the experiment
try:
	duration = input('Enter the duration of the attack [defaults=%s s], -1=forever:  '%duration)
	print
except KeyboardInterrupt:
	sys.exit(0)
except:
	print "duration not provided, using defaults (%s)"%duration
	print 


print "STARTING DOCKEMU BOT-NET ...."
names=[]

#by the moment just support 253 ftpservers
if ftpservers > 253:
	print "ftpservers can not be > 253"
	sys.exit(0)

ftpserver_list=[]
ftpserver_ips=""
#Starting servers
for i in range(ftpservers):
	
	cmd="docker run -e 'ipaddress=172.17.%s.5' -d -v %s/log/:/var/log/dockemu/ --name dockemu-ftpserver-%s --privileged %s &>/dev/null"%(i,ROOT,i,imagegg)
	print cmd
	try:
		print
		try:
			p = subprocess.Popen(cmd , shell=True)
			logging.info("STARTING dockemu-ftpserver-%s with IPAddress 172.17.%s.5"%(i,i))
			ftpserver_list=ftpserver_list+["dockemu-ftpserver-%s"%i]
			ftpserver_ips=ftpserver_ips+"  172.17.%s.5"%i
			time.sleep(1)
		except:
			print "CANNOT START dockemu-ftpserver-%s"%i

	except:
		print traceback.format_exc()
		print "ERROR IN LOG dockemu-ftpserver-%s"%i
failed=False

time.sleep(2)

print ftpserver_list
print ftpserver_ips

if bots > 253:
	print "bots can not be > 253"
	sys.exit(0)

for i in range(bots):
	cmd="docker run -d -v %s/log/:/var/log/dockemu/ --name  dockemu-%s %s ./attackftp %s &>/dev/null"%(ROOT,i,imagebot,ftpserver_ips)
	print cmd
	sys.exit(0)
	try:
		print
		try:
			p = subprocess.Popen(cmd , shell=True)
			logging.info("STARTING dockemu-%s"%i)
			time.sleep(1)
		except:
			print "CANNOT START dockemu-%s"%i
		
		output = subprocess.check_output("docker inspect dockemu-%s"%i, shell=True)
		for IP in output.splitlines():
			if "IPAddress" in IP:
				print IP
				logging.info("dockemu-"+str(i)+IP)
		

	except:
		print traceback.format_exc()
		print "ERROR IN LOG dockemu-%s"%i
	time.sleep(delay)


failed=False

if duration > 0:
	print
	print "Waiting %ss to stop the attack (all docker botnet)"%duration
	time.sleep(duration)
	
	try:
                for i in range(ftpservers):
                        cmd="docker kill dockemu-ftpserver-%s && docker stop dockemu-ftpserver-%s  && docker rm dockemu-ftpserver-%s "%(i,i,i)
                        logging.info("ENDING dockemu-ftpserver-%s"%i)
                        print cmd
                        try:
                                p = subprocess.Popen(cmd , shell=True)
                                print s
                        except:
                                failed=True
                                print "failed to stop dockemu-ftpserver-%s!!"%i
        except:
                cmd="docker stop $(docker ps -a -q) && docker rm $(docker ps -a -q)"
                p = subprocess.Popen(cmd , shell=True)
	

	try:
		for i in range(bots):
			cmd="docker kill dockemu-%s && docker stop dockemu-%s  && docker rm dockemu-%s "%(i,i,i)
			logging.info("ENDING dockemu-%s"%i)
			print cmd
			try:
				p = subprocess.Popen(cmd , shell=True)
				print s
			except:
				failed=True
				print "failed to stop dockemu-%s!!"%i
	except:
		cmd="docker stop $(docker ps -a -q) && docker rm $(docker ps -a -q)"
		p = subprocess.Popen(cmd , shell=True)

